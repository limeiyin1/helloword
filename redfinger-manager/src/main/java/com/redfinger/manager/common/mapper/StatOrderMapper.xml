<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.redfinger.manager.common.mapper.StatOrderMapper">
  <resultMap id="BaseOrderMap" type="com.redfinger.manager.common.domain.RfOrder">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 26 11:42:50 CST 2015.
    -->
    <id column="order_id" jdbcType="VARCHAR" property="orderId" />
    <result column="pad_id" jdbcType="INTEGER" property="padId" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="pad_code" jdbcType="VARCHAR" property="padCode" />
    <result column="pad_grade" jdbcType="VARCHAR" property="padGrade" />
    <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="order_type" jdbcType="VARCHAR" property="orderType" />
    <result column="order_price" jdbcType="INTEGER" property="orderPrice" />
    <result column="real_fee" jdbcType="INTEGER" property="realFee" />
    <result column="real_pay_amount" jdbcType="INTEGER" property="realPayAmount" />
    <result column="favourable_fee" jdbcType="INTEGER" property="favourableFee" />
    <result column="order_status" jdbcType="VARCHAR" property="orderStatus" />
    <result column="pay_mode_code" jdbcType="VARCHAR" property="payModeCode" />
    <result column="enable_status" jdbcType="VARCHAR" property="enableStatus" />
    <result column="creater" jdbcType="VARCHAR" property="creater" />
    <result column="modifier" jdbcType="VARCHAR" property="modifier" />
    <result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" />
    <result column="reorder" jdbcType="INTEGER" property="reorder" />
    <result column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="goods_id" jdbcType="INTEGER" property="goodsId" />
    <result column="order_biz_type" jdbcType="VARCHAR" property="orderBizType" />
    <result column="finish_time" jdbcType="TIMESTAMP" property="finishTime" />
    <result column="order_create_time" jdbcType="TIMESTAMP" property="orderCreateTime" />
    <result column="online_time" jdbcType="INTEGER" property="onlineTime" />
  </resultMap>
	<resultMap id="BaseResultMap" type="com.redfinger.manager.modules.stat.base.StatDomain">
		<result column="id" jdbcType="INTEGER" property="id" />
		<result column="number" jdbcType="INTEGER" property="number" />
		<result column="amount" jdbcType="DOUBLE" property="amount" />
		<result column="label" jdbcType="VARCHAR" property="label" />
	</resultMap>
<!--计算金额  -->
 <sql id="Example_Where_Clause">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Sep 26 11:42:50 CST 2015.
    -->
    <where>
      <foreach collection="oredCriteria" item="criteria" separator="or">
        <if test="criteria.valid">
          <trim prefix="(" prefixOverrides="and" suffix=")">
            <foreach collection="criteria.criteria" item="criterion">
              <choose>
                <when test="criterion.noValue">
                  and ${criterion.condition}
                </when>
                <when test="criterion.singleValue">
                  and ${criterion.condition} #{criterion.value}
                </when>
                <when test="criterion.betweenValue">
                  and ${criterion.condition} #{criterion.value} and #{criterion.secondValue}
                </when>
                <when test="criterion.listValue">
                  and ${criterion.condition}
                  <foreach close=")" collection="criterion.value" item="listItem" open="(" separator=",">
                    #{listItem}
                  </foreach>
                </when>
              </choose>
            </foreach>
          </trim>
        </if>
      </foreach>
    </where>
  </sql>
   <select id="priceByExample" parameterType="com.redfinger.manager.common.domain.RfOrderExample" resultType="java.lang.Integer">
    select sum(order_price) from rf_order where  order_status in('1','3','4','5') and
    <if test="orderId != null">
        order_id = #{orderId,jdbcType=VARCHAR} and
      </if>
      <if test="padId != null">
        pad_id = #{padId,jdbcType=INTEGER} and
      </if>
      <if test="createTime != null">
        create_time = #{createTime,jdbcType=TIMESTAMP} and
      </if>
      <if test="remark != null">
        remark = #{remark,jdbcType=VARCHAR} and
      </if>
      <if test="padCode != null">
        pad_code = #{padCode,jdbcType=VARCHAR} and
      </if>
      <if test="padGrade != null">
        pad_grade = #{padGrade,jdbcType=VARCHAR} and
      </if>
      <if test="status != null">
        status = #{status,jdbcType=VARCHAR} and
      </if>
      <if test="orderType != null">
        order_type = #{orderType,jdbcType=VARCHAR} and
      </if>
      <if test="orderPrice != null">
        order_price = #{orderPrice,jdbcType=INTEGER} and
      </if>
      <if test="realFee != null">
        real_fee = #{realFee,jdbcType=INTEGER} and
      </if>
      <if test="realPayAmount != null">
        real_pay_amount = #{realPayAmount,jdbcType=INTEGER} and
      </if>
      <if test="favourableFee != null">
        favourable_fee = #{favourableFee,jdbcType=INTEGER} and
      </if>
      <if test="payModeCode != null">
        pay_mode_code = #{payModeCode,jdbcType=VARCHAR} and
      </if>
      <if test="creater != null">
        creater = #{creater,jdbcType=VARCHAR} and
      </if>
      <if test="modifier != null">
        modifier = #{modifier,jdbcType=VARCHAR} and
      </if>
      <if test="modifyTime != null">
        modify_time = #{modifyTime,jdbcType=TIMESTAMP} and
      </if> 
      <if test="reorder != null">
        reorder = #{reorder,jdbcType=INTEGER} and
      </if>
      <if test="userId != null">
        user_id = #{userId,jdbcType=INTEGER} and
      </if>
      <if test="goodsId != null">
        goods_id = #{goodsId,jdbcType=INTEGER} and
      </if>
      <if test="orderBizType != null">
        order_biz_type = #{orderBizType,jdbcType=VARCHAR} and
      </if>
      <if test="finishTime != null">
        finish_time = #{finishTime,jdbcType=TIMESTAMP} and
      </if>
      <if test="orderCreateTime != null">
        order_create_time >= #{orderCreateTime,jdbcType=TIMESTAMP} and
      </if>
      <if test="onlineTime != null">
        online_time = #{onlineTime,jdbcType=INTEGER} and
      </if>
       <if test="enableStatus != null">
        enable_status = #{enableStatus,jdbcType=VARCHAR} 
      </if>
  </select>

	<select id="statSucceedOrder" parameterType="com.redfinger.manager.modules.stat.base.StatDomain" resultMap="BaseResultMap">
		<![CDATA[
		
		SELECT  SUM(order_price)/100 as number,to_char(date_trunc('${type}',order_create_time), '${formart}') as label from rf_order where  order_create_time >=to_date('${begin}','yyyy-MM-DD')  and   order_create_time < (to_date('${end}','yyyy-MM-DD')+ integer '1') and  order_status in('1','3','4','5')	
		]]> 
		<if test="where!=null">
				and ${where}
			</if>
		<![CDATA[
			group by label
			order by number asc
		]]>
	</select>

	<select id="statSucceedOrderCount" parameterType="com.redfinger.manager.modules.stat.base.StatDomain" resultMap="BaseResultMap">
		<![CDATA[
		
		SELECT  COUNT(order_id) as number,to_char(date_trunc('${type}',order_create_time), '${formart}') as label from rf_order where  order_create_time >=to_date('${begin}','yyyy-MM-DD')  and   order_create_time < (to_date('${end}','yyyy-MM-DD')+ integer '1') and  order_status in('1','3','4','5')	
		]]> 
		<if test="where!=null">
				and ${where}
			</if>
		<![CDATA[
			group by label
			order by number asc
		]]>
	</select>
	
	
	<select id="statSucceedOrderGoods" parameterType="com.redfinger.manager.modules.stat.base.StatDomain" resultMap="BaseResultMap">
		<![CDATA[
		SELECT COUNT (1) AS number,order_price/100 AS amount,to_char(date_trunc('${type}',order_create_time), '${formart}') as label FROM rf_order WHERE order_status IN ('1', '3', '4', '5')
		]]> 
		<if test="where!=null">
				and ${where}
			</if>
		<![CDATA[
		group by label,amount
        order by label,amount
		]]>
	</select>
	
	
	
	<select id="statSucceedOrder1" parameterType="com.redfinger.manager.modules.stat.base.StatDomain" resultMap="BaseResultMap">
		<![CDATA[
		
		SELECT  COUNT (1) as number, order_create_time as label from rf_order where  order_create_time >=to_date('${begin}','yyyy-MM-DD')  and   order_create_time < (to_date('${end}','yyyy-MM-DD')+ integer '1') and  order_status in('1','3','4','5')	
		]]> 
		<if test="where!=null">
				and ${where}
			</if>
		<![CDATA[
			group by label
			order by number asc
		]]>
	</select>
	
	<resultMap id="Map" type="com.redfinger.manager.common.domain.RfUser">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Oct 15 15:11:58 CST 2015.
    -->
    <id column="user_id" jdbcType="INTEGER" property="userId" />
    <result column="user_pwd" jdbcType="VARCHAR" property="userPwd" />
    <result column="user_name" jdbcType="VARCHAR" property="userName" />
    <result column="user_image_url" jdbcType="VARCHAR" property="userImageUrl" />
    <result column="user_gender" jdbcType="VARCHAR" property="userGender" />
    <result column="user_mobile_phone" jdbcType="VARCHAR" property="userMobilePhone" />
    <result column="mobile_carriers" jdbcType="VARCHAR" property="mobileCarriers" />
    <result column="user_email" jdbcType="VARCHAR" property="userEmail" />
    <result column="user_level" jdbcType="VARCHAR" property="userLevel" />
    <result column="user_status" jdbcType="VARCHAR" property="userStatus" />
    <result column="register_ip" jdbcType="VARCHAR" property="registerIp" />
    <result column="login_type" jdbcType="VARCHAR" property="loginType" />
    <result column="login_ip" jdbcType="VARCHAR" property="loginIp" />
    <result column="login_time" jdbcType="TIMESTAMP" property="loginTime" />
    <result column="login_count" jdbcType="INTEGER" property="loginCount" />
    <result column="status" jdbcType="VARCHAR" property="status" />
    <result column="number" jdbcType="VARCHAR" property="creater" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="money" jdbcType="VARCHAR" property="modifier" />
    <result column="modify_time" jdbcType="TIMESTAMP" property="modifyTime" />
    <result column="reorder" jdbcType="INTEGER" property="reorder" />
    <result column="remark" jdbcType="VARCHAR" property="remark" />
    <result column="bind_pad_max" jdbcType="INTEGER" property="bindPadMax" />
    <result column="reset_validata_code" jdbcType="VARCHAR" property="resetValidataCode" />
    <result column="reset_validata_time" jdbcType="TIMESTAMP" property="resetValidataTime" />
    <result column="enable_status" jdbcType="VARCHAR" property="enableStatus" />
    <result column="user_birth" jdbcType="TIMESTAMP" property="userBirth" />
    <result column="card_id" jdbcType="VARCHAR" property="cardId" />
    <result column="first_apply_status" jdbcType="VARCHAR" property="firstApplyStatus" />
    <result column="left_online_time" jdbcType="INTEGER" property="leftOnlineTime" />
    <result column="pad_login_daily_status" jdbcType="VARCHAR" property="padLoginDailyStatus" />
    <result column="user_email_pwd" jdbcType="VARCHAR" property="userEmailPwd" />
    <result column="edu" jdbcType="VARCHAR" property="edu" />
    <result column="occupation" jdbcType="VARCHAR" property="occupation" />
    <result column="nick_name" jdbcType="VARCHAR" property="nickName" />
    <result column="address" jdbcType="VARCHAR" property="address" />
    <result column="qq" jdbcType="VARCHAR" property="qq" />
    <result column="wechat" jdbcType="VARCHAR" property="wechat" />
    <result column="mobile_bind_status" jdbcType="VARCHAR" property="mobileBindStatus" />
    <result column="rbc_amount" jdbcType="INTEGER" property="rbcAmount" />
    <result column="user_id_tmp" jdbcType="VARCHAR" property="userIdTmp" />
    <result column="apply_exper_status" jdbcType="VARCHAR" property="applyExperStatus" />
  </resultMap>
		<!-- 统计一个时间段每个用户的订单数总金额 -->
	<select id="statOrder2Time" parameterType="com.redfinger.manager.modules.stat.base.StatDomain" resultMap="Map">
		<![CDATA[
		select user_id,user_mobile_phone ,user_email ,number,money
		from rf_user x left join(SELECT user_id as label,count(1) as number,sum(order_price) as money FROM rf_order WHERE order_status IN ('1', '3', '4', '5') and order_create_time >= to_date('${begin}', 'yyyy-MM-DD') and order_create_time < (to_date('${end}', 'yyyy-MM-DD') + INTEGER '1')
			group by label
			order by label asc)t on x.user_id=t.label 
		where x.user_id=t.label
		]]> 
		<if test="where!=null">
			 ${where}
		</if>
	</select>
	
<!--  每天新增付费用户-->	
	
<select id="statPayForTheFirstTime" parameterType="com.redfinger.manager.modules.stat.base.StatDomain" resultType="java.lang.Integer">
    <![CDATA[
		SELECT count(1) AS number FROM(
		SELECT
		 DISTINCT	t1.user_id
		FROM
			rf_order t1
		WHERE
			t1.order_status IN ('1', '3', '4', '5','6')
		AND t1.create_time >= to_date('${begin}', 'yyyy-MM-dd')
		AND t1.create_time <  to_date('${end}', 'yyyy-MM-dd')
		AND NOT EXISTS (
			SELECT
				t2.user_id
			FROM
				rf_order t2
			WHERE
				t2.create_time < to_date('${begin}', 'yyyy-MM-dd')
		        AND t2.order_status IN ('1', '3', '4', '5','6')
			    AND t2.user_id = t1.user_id
		)
		)t3
	]]> 
	</select>
	
	<!-- 付费后一段时间内没有消费记录，现在有付费的用户 -->
<select id="statAgainPay" parameterType="com.redfinger.manager.modules.stat.base.StatDomain" resultType="java.lang.Integer">
    <![CDATA[
		SELECT count(1) FROM(
		SELECT
			t1.user_id
		FROM
			rf_order t1
		WHERE
			t1.order_status IN ('1', '3', '4', '5')
		AND t1.create_time >= to_date('${begin}', 'yyyy-MM-dd')
		AND t1.create_time <  to_date('${end}', 'yyyy-MM-dd')
		AND NOT EXISTS (
			SELECT
				t2.user_id
			FROM
				rf_order t2
			WHERE
				t2.create_time < to_date('${begin}', 'yyyy-MM-dd')
			AND t2.create_time >= to_date('${formart}', 'yyyy-MM-dd')
			AND t2.user_id=t1.user_id 
			GROUP BY
				t2.user_id
		)
		AND EXISTS(
			SELECT
				t2.user_id
			FROM
				rf_order t2
			WHERE
				t2.create_time < to_date('${formart}', 'yyyy-MM-dd')
				AND t2.user_id = t1.user_id
		)
		GROUP BY t1.user_id
		)t3
	]]> 
	</select>
</mapper>